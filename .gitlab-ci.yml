image: java:8-jdk

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

before_script:
  - export GRADLE_USER_HOME=`pwd`/.gradle

stages:
 - build
 - test
 - devDeploy
 - systemTest

build:
  stage: build
  script: ./gradlew --build-cache assemble -s
  artifacts:
    paths:
      - subprojects/**/build/libs/*.jar
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: push
    paths:
      - .gradle
      - subprojects/**/build

build with latest Gradle:
  image: gradle:latest
  stage: build
  script: gradle assemble
  allow_failure: true

test:
  stage: test
  script:
    - ./gradlew check jacocoTestReport
    - bash <(curl -s https://codecov.io/bash)
  artifacts:
    reports:
      junit: subprojects/**/build/test-results/**/TEST-*.xml
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: pull
    paths:
      - .gradle
      - subprojects/**/build

deploy to GitLab:
  stage: devDeploy
  script: ./gradlew publish -s
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: pull
    paths:
      - .gradle
      - subprojects/**/build

.system test template:
  stage: systemTest
  script:
   - cd subprojects/changelog-automation-system-tests/
   - gradle fetchChangelogScript -s
   - chmod +x scripts/changelog.sh
   - ./scripts/changelog.sh --type added "Test entry"
   - gradle processChangelogEntries -s

Gradle latest JDK 8:
  extends: .system test template
  image: gradle:latest

Gradle latest JDK 8 in legacy mode:
  extends: .system test template
  image: gradle:latest
  script:
   - cd subprojects/changelog-automation-legacy-system-tests/
   - gradle fetchChangelogScript -s
   - chmod +x scripts/changelog.sh
   - ./scripts/changelog.sh --type added "Test entry"
   - gradle processChangelogEntries -s

Gradle latest JDK 11:
  extends: .system test template
  image: gradle:jdk11

Gradle 5.0 JDK 8:
  extends: .system test template
  image: gradle:5.0.0-jdk8

Gradle 4.10.3 JDK 8:
  extends: .system test template
  image: gradle:4.10.3-jdk8

Gradle 4.0 JDK 8:
  extends: .system test template
  image: gradle:4.0-jdk8

Gradle 3.5 JDK 8:
  extends: .system test template
  image: gradle:3.5-jdk8

.system test template with wrapper:
  extends: .system test template
  variables:
    GRADLE_VERSION: "3.0"
  script:
   - cd subprojects/changelog-automation-legacy-system-tests
   - ./gradlew wrapper --gradle-version "$GRADLE_VERSION"
   - ./gradlew fetchChangelogScript -s
   - chmod +x scripts/changelog.sh
   - ./scripts/changelog.sh --type added "Test entry"
   - ./gradlew processChangelogEntries -s

Gradle 3.0 JDK 8:
  extends: .system test template with wrapper

Gradle 2.14.1 JDK 8:
  extends: .system test template with wrapper
  variables:
    GRADLE_VERSION: "2.14.1"

Gradle 2.0 JDK 8:
  extends: .system test template with wrapper
  variables:
    GRADLE_VERSION: "2.0"
  allow_failure: true

Gradle 1.12 JDK 8:
  extends: .system test template with wrapper
  variables:
    GRADLE_VERSION: "1.12"
  allow_failure: true
