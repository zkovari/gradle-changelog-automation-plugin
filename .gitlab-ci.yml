image: java:8-jdk

variables:
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"

before_script:
  - export GRADLE_USER_HOME=`pwd`/.gradle

stages:
 - build
 - test
 - devDeploy
 - systemTest

test script:
  stage: build
  script:
   - cd subprojects/changelog-automation-bin/src/main/resources/
   - chmod +x ./changelog.sh
   - ./changelog.sh -t added "Title message"
   - ls -al
   - cat changelogs/unreleased/*.yml

.build:
  stage: build
  script: ./gradlew --build-cache assemble -s
  artifacts:
    paths:
      - subprojects/**/build/libs/*.jar
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: push
    paths:
      - .gradle
      - subprojects/**/build

.build with latest Gradle:
  image: gradle:latest
  stage: build
  script: gradle assemble
  allow_failure: true

.test:
  stage: test
  script:
    - ./gradlew check jacocoTestReport
    - bash <(curl -s https://codecov.io/bash)
  artifacts:
    reports:
      junit: subprojects/**/build/test-results/**/TEST-*.xml
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: pull
    paths:
      - .gradle
      - subprojects/**/build

deploy to GitLab:
  stage: devDeploy
  script: ./gradlew publish -s
  cache:
    key: "$CI_COMMIT_REF_NAME"
    policy: pull
    paths:
      - .gradle
      - subprojects/**/build

Gradle latest JDK 8:
  stage: systemTest
  image: gradle:latest
  script: gradle -p subprojects/changelog-automation-system-tests/ processChangelogEntries -s

Gradle latest JDK 8 in legacy mode:
  stage: systemTest
  image: gradle:latest
  script: gradle -p subprojects/changelog-automation-legacy-system-tests/ processChangelogEntries -s

Gradle latest JDK 11:
  stage: systemTest
  image: gradle:jdk11
  script: gradle -p subprojects/changelog-automation-system-tests/ processChangelogEntries -s

Gradle 5.0 JDK 8:
  stage: systemTest
  image: gradle:5.0.0-jdk8
  script: gradle -p subprojects/changelog-automation-system-tests/ processChangelogEntries -s

Gradle 4.10.3 JDK 8:
  stage: systemTest
  image: gradle:4.10.3-jdk8
  script: gradle -p subprojects/changelog-automation-system-tests/ processChangelogEntries -s

Gradle 4.0 JDK 8:
  stage: systemTest
  image: gradle:4.0-jdk8
  script: gradle -p subprojects/changelog-automation-system-tests/ processChangelogEntries -s

Gradle 3.5 JDK 8:
  stage: systemTest
  image: gradle:3.5-jdk8
  script: gradle -p subprojects/changelog-automation-system-tests/ processChangelogEntries -s

Gradle 3.0 JDK 8:
  stage: systemTest
  script:
   - ./gradlew wrapper --gradle-version 3.0
   - ./gradlew -p subprojects/changelog-automation-legacy-system-tests/ processChangelogEntries -s

Gradle 2.14.1 JDK 8:
  stage: systemTest
  script:
   - ./gradlew wrapper --gradle-version 2.14.1
   - ./gradlew -p subprojects/changelog-automation-legacy-system-tests/ processChangelogEntries -s

Gradle 2.0 JDK 8:
  stage: systemTest
  script:
   - ./gradlew wrapper --gradle-version 2.0
   - ./gradlew -p subprojects/changelog-automation-legacy-system-tests/ processChangelogEntries -s
  allow_failure: true

Gradle 1.12 JDK 8:
  stage: systemTest
  script:
   - ./gradlew wrapper --gradle-version 1.12
   - ./gradlew -p subprojects/changelog-automation-legacy-system-tests/ processChangelogEntries -s
  allow_failure: true
